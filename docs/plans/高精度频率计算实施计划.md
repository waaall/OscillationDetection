# 频率精细化方案实施计划

## 目标
将 FFT 频率估计精度从 **0.01-0.05 Hz** 提升到 **0.001-0.002 Hz**，通过 "FFT粗估 + 最小二乘拟合" 方法。

## 设计决策总结

基于深入分析，采用以下方案：

### 核心算法
- **方法**：`scipy.optimize.minimize_scalar` (Brent法) + 线性最小二乘
- **原理**：将4参数问题(f, A, φ, DC)分解为 1参数优化(f) + 3参数线性求解(A, φ, DC)
- **性能**：<1ms 额外耗时（远低于预期的3-4倍）
- **精度**：SNR≥40dB 时达到 1-2 mHz

### 集成策略
- **新建模块**：`FrequencyRefinement.py`（独立可测试）
- **最小侵入**：`FFT_analyzer.fft_analyze()` 添加可选参数 `refine_frequency=False`
- **向后兼容**：默认关闭精化，现有代码无需修改
- **使用场景**：仅单次分析，不在循环中使用

### 配置参数
- **搜索范围**：自适应计算，`range = max(5*Δf, 0.05)`，若落在 49–51Hz 再取 `min(range, 0.5)` 软限制；精化失败时自动扩大一档
- **搜索方法**：Brent一维优化（默认）或网格搜索（备选）
- **收敛条件**：tolerance=1e-9, max_iterations=100

---

## 验收标准

### 功能验收
- [ ] FrequencyRefinement 模块独立可运行
- [ ] FFT_analyzer 向后兼容（默认不启用精化）
- [ ] simple_test() 能对比三种方法精度
- [ ] 测试套件全部通过

### 性能验收
- [ ] 精度：SNR≥40dB 时误差 ≤2mHz
- [ ] 性能：单次精化耗时 <2ms
- [ ] 鲁棒性：FFT初值偏差±0.05Hz内收敛

### 代码质量
- [ ] 所有函数有中文注释
- [ ] 关键参数可配置（不硬编码）
- [ ] 日志系统集成
- [ ] 错误处理完善（降级策略）

---

## 潜在问题与缓解

### 问题1: 多频信号精度下降
- **现象**：电网信号含谐波，单频模型拟合残差大
- **缓解**：当残差 > 阈值时记录警告日志
- **未来**：扩展为多频模型（预留接口）

### 问题2: 数据长度不足
- **现象**：<160点时精度显著下降
- **缓解**：检查数据长度，不足时返回None并记录警告

### 问题3: 极端噪声环境
- **现象**：SNR<20dB时可能不收敛或误差大
- **缓解**：计算拟合残差，超阈值时警告

### 问题4: 性能累积影响
- **现象**：在Freq_dynamic_analyzer循环中使用会显著拖慢
- **缓解**：文档明确说明仅适用于单次分析，默认关闭

---
